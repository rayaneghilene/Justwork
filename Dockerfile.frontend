# Frontend Dockerfile for Streamlit app
FROM python:3.11-slim

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements
COPY requirements.txt .

# Install Python dependencies (only what's needed for frontend)
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir streamlit requests

# Copy frontend code
COPY frontend/ ./frontend/

# Set environment variables
ENV PYTHONPATH=/app

# Expose Streamlit port
EXPOSE 8501

# Health check
HEALTHCHECK --interval=30s --timeout=30s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8501/_stcore/health || exit 1

# Create startup script for debugging
RUN echo '#!/bin/bash\n\
echo "🚀 Starting JustWork Frontend..."\n\
echo "📡 Backend URL: $BACKEND_URL"\n\
echo "🔍 Testing backend connectivity..."\n\
if curl -f --connect-timeout 10 "$BACKEND_URL" > /dev/null 2>&1; then\n\
  echo "✅ Backend is reachable"\n\
else\n\
  echo "❌ Backend is not reachable at $BACKEND_URL"\n\
  echo "🔍 Trying to resolve justwork-backend..."\n\
  nslookup justwork-backend || echo "DNS resolution failed"\n\
fi\n\
echo "🎯 Starting Streamlit on 0.0.0.0:8501"\n\
streamlit run frontend/app.py --server.address 0.0.0.0 --server.port 8501 --server.headless true\n\
' > /app/start.sh && chmod +x /app/start.sh

# Install nslookup for debugging
RUN apt-get update && apt-get install -y dnsutils && rm -rf /var/lib/apt/lists/*

# Run startup script
CMD ["/app/start.sh"]
